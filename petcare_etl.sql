USE petcare;

DELIMITER |

DROP TRIGGER IF EXISTS update_cred|
CREATE TRIGGER update_cred
	AFTER INSERT ON user
    FOR EACH ROW
    BEGIN
		INSERT INTO Credentials VALUES (new.UserID, new.Email, concat(new.LastName, new.UserID), 'guest');
    END|
    
DELIMITER ;

CREATE DATABASE IF NOT EXISTS stage;


CREATE TABLE IF NOT EXISTS stage.petcare_load
	(
		id INT(11),
        first_name VARCHAR(50),
        last_name VARCHAR(50),
        address VARCHAR(100),
        city VARCHAR(45),
        county VARCHAR(45),
        state VARCHAR(2),
        zip VARCHAR(5),
        phone VARCHAR(14),
        email VARCHAR(50),
        pet_name VARCHAR(150),
        pet_type VARCHAR(150),
        pet_gender VARCHAR(150),
        pet_size VARCHAR(50),
        pet_special_needs VARCHAR(150),
        CONSTRAINT petcare_load_id PRIMARY KEY (id),
        CONSTRAINT petcare_load_email_uk UNIQUE (email)
	)
;

DROP VIEW IF EXISTS stage.user_load_v;
CREATE VIEW stage.user_load_v AS
	(
		SELECT id as UserID
			, last_name
			, first_name
			, address
            , city
            , state
            , county
            , right(concat('00000', zip), 5) zip
            , email
			, phone
            FROM stage.petcare_load
	)
;

DROP VIEW IF EXISTS stage.pet_load_v;
CREATE VIEW stage.pet_load_v AS
	(
		SELECT id as UserID
			, pet_name
            , pet_type
            , pet_gender
            , pet_size
            , pet_special_needs
			FROM stage.petcare_load
	)
;

DROP VIEW IF EXISTS stage.pet_load_trans_v;
CREATE VIEW stage.pet_load_trans_v AS
	(
		SELECT UserID
			, TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t.pet_name, ',', n.n), ',', -1)) pet_name
			, TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t.pet_type, ',', n.n), ',', -1)) pet_type
			, TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t.pet_gender, ',', n.n), ',', -1)) pet_gender
			, TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t.pet_size, ',', n.n), ',', -1)) pet_size
			, TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t.pet_special_needs, ',', n.n), ',', -1)) pet_special_needs
			FROM stage.pet_load_v t 
				CROSS JOIN 
					(
						SELECT a.N + b.N * 10 + 1 n
							FROM 
								(SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3) a,
								(SELECT 0 AS N UNION ALL SELECT 1 UNION ALL SELECT 2 UNION ALL SELECT 3) b
							ORDER BY n
					) n
			WHERE n.n <= 1 + (LENGTH(t.pet_name) - LENGTH(REPLACE(t.pet_name, ',', '')))
	)
;

DROP TABLE IF EXISTS stage.user_load_trans;
CREATE TABLE stage.user_load_trans AS
	(
		SELECT *
			, 'N' Student
			, FLOOR(1 + RAND()*17) OccupationID
            FROM stage.user_load_v
	)
;

DROP TABLE IF EXISTS stage.pet_load_trans;
CREATE TABLE stage.pet_load_trans AS
	(
		SELECT UserID
			, pet_name
            , CASE WHEN pet_type = 'Dog' THEN 1 ELSE 2 END PetTypeID
            , pet_gender
            , pet_size
            , pet_special_needs
			FROM stage.pet_load_trans_v
            WHERE pet_name <> ''
    )
;

SET SQL_SAFE_UPDATES = 0;

UPDATE stage.user_load_trans 
	SET Student = 'Y' 
    WHERE OccupationID = 2
;


INSERT INTO petcare.pettypes
	VALUES (1, 'Dog'),
		   (2, 'Cat')
;

INSERT INTO petcare.service
	VALUES (1,'Board Overnight',22),
		   (2,'Visit',8),
		   (3,'Walk',12),
		   (4,'Feed',8),
		   (5,'Day Care',15),
		   (6,'Bathe',20),
		   (7,'Shop Pick Up Food or Supplies',12),
		   (8,'Medicine',12)
;


INSERT INTO petcare.occupation
	VALUES (1, 'Teacher'),
		   (2, 'Student'),
           (3, 'Accountant'),
           (4, 'Finance'),
           (5, 'Engineer'),
           (6, 'Sales'),
           (7, 'Nurse'),
		   (8, 'Doctor'),
		   (9, 'Unemployed'),
		   (10, 'Plumber'),
		   (11, 'Mechanic'),
		   (12, 'Welder'),
		   (13, 'Farmer'),
		   (14, 'Trainer'),
		   (15, 'Film Director'),
		   (16, 'Data Scientist'),
		   (17, 'Attorney')
;


INSERT INTO petcare.user
	(
		SELECT * FROM stage.user_load_trans
	)
;


DROP TABLE IF EXISTS stage.cust_temp;
CREATE TABLE stage.cust_temp 
	(
		UserID INT(11),
        Dates VARCHAR(45)
	)
;

insert into stage.cust_temp
Values (1,'12/02/2017'),
(2,'12/19/2015'),
(3,'08/06/2013'),
(4,'10/24/2014'),
(5,'06/21/2014'),
(6,'12/14/2015'),
(7,'01/23/2016'),
(8,'08/04/2013'),
(9,'02/03/2018'),
(10,'01/10/2017'),
(11,'10/09/2014'),
(12,'01/13/2017'),
(13,'05/08/2016'),
(14,'08/02/2017'),
(15,'12/06/2016'),
(16,'01/07/2015'),
(17,'12/25/2015'),
(18,'10/12/2014'),
(19,'08/14/2017'),
(20,'12/17/2014'),
(21,'01/29/2015'),
(22,'08/29/2015'),
(23,'08/03/2017'),
(24,'08/22/2013'),
(25,'10/13/2016'),
(26,'01/21/2018'),
(27,'01/06/2017'),
(28,'06/19/2017'),
(29,'08/02/2014'),
(30,'09/24/2017'),
(31,'01/29/2018'),
(32,'04/20/2016'),
(33,'08/20/2016'),
(34,'11/14/2016'),
(35,'02/28/2015'),
(36,'08/09/2013'),
(37,'08/06/2014'),
(38,'01/16/2017'),
(39,'07/09/2017'),
(40,'10/31/2013'),
(41,'12/10/2017'),
(42,'05/29/2015'),
(43,'09/24/2015'),
(44,'10/25/2015'),
(45,'04/14/2014'),
(46,'01/16/2016'),
(47,'02/19/2018'),
(48,'07/05/2016'),
(49,'04/20/2016'),
(50,'11/13/2013'),
(51,'02/05/2018'),
(52,'07/14/2014'),
(53,'07/03/2016'),
(54,'04/27/2014'),
(55,'10/03/2015'),
(56,'11/11/2014'),
(57,'02/13/2016'),
(58,'12/07/2016'),
(59,'09/05/2017'),
(60,'09/28/2016'),
(61,'12/12/2014'),
(62,'04/27/2018'),
(63,'09/25/2017'),
(64,'08/23/2016'),
(65,'02/12/2018'),
(66,'05/02/2018'),
(67,'02/24/2015'),
(68,'02/26/2017'),
(69,'10/18/2015'),
(70,'07/10/2013'),
(71,'05/27/2017'),
(72,'08/19/2013'),
(73,'09/12/2013'),
(74,'02/06/2014'),
(75,'01/13/2016'),
(76,'01/10/2014'),
(77,'09/18/2013'),
(78,'01/19/2016'),
(79,'01/03/2014'),
(80,'08/02/2015'),
(81,'09/30/2016'),
(82,'05/14/2018'),
(83,'01/30/2017'),
(84,'10/29/2013'),
(85,'06/14/2016'),
(86,'06/21/2013'),
(87,'05/06/2017'),
(88,'04/12/2018'),
(89,'08/21/2014'),
(90,'12/23/2016'),
(91,'05/29/2014'),
(92,'05/21/2015'),
(93,'10/20/2014'),
(94,'11/19/2015'),
(95,'09/11/2014'),
(96,'01/25/2018'),
(97,'12/11/2015'),
(98,'02/09/2016'),
(99,'04/17/2014'),
(100,'06/23/2015'),
(101,'07/25/2014'),
(102,'03/22/2018'),
(103,'08/10/2016'),
(104,'04/08/2016'),
(105,'08/28/2013'),
(106,'06/14/2015'),
(107,'09/16/2016'),
(108,'04/17/2017'),
(109,'08/21/2016'),
(110,'09/26/2014'),
(111,'07/10/2016'),
(112,'11/23/2013'),
(113,'12/21/2016'),
(114,'09/09/2015'),
(115,'07/02/2016'),
(116,'04/04/2018'),
(117,'01/13/2017'),
(118,'09/05/2014'),
(119,'02/04/2018'),
(120,'08/31/2016'),
(121,'01/17/2014'),
(122,'07/08/2015'),
(123,'01/24/2014'),
(124,'04/24/2014'),
(125,'10/25/2017'),
(126,'09/16/2016'),
(127,'09/15/2013'),
(128,'01/17/2017'),
(129,'08/24/2016'),
(130,'02/27/2014'),
(131,'09/08/2015'),
(132,'12/26/2013'),
(133,'04/14/2014'),
(134,'07/12/2013'),
(135,'07/18/2013'),
(136,'01/06/2018'),
(137,'01/18/2016'),
(138,'06/15/2015'),
(139,'12/05/2013'),
(140,'05/15/2018'),
(141,'03/03/2017'),
(142,'03/17/2014'),
(143,'01/01/2014'),
(144,'06/26/2015'),
(145,'03/13/2016'),
(146,'07/05/2014'),
(147,'05/29/2017'),
(148,'11/06/2016'),
(149,'01/28/2017'),
(150,'09/30/2015'),
(151,'07/19/2013'),
(152,'12/19/2016'),
(153,'07/04/2016'),
(154,'10/24/2017'),
(155,'05/23/2014'),
(156,'10/16/2017'),
(157,'12/20/2015'),
(158,'04/03/2017'),
(159,'12/15/2014'),
(160,'03/19/2018'),
(161,'03/05/2017'),
(162,'03/29/2016'),
(163,'03/31/2015'),
(164,'06/22/2015'),
(165,'08/11/2016'),
(166,'01/12/2017'),
(167,'09/24/2017'),
(168,'04/15/2014'),
(169,'11/26/2013'),
(170,'02/27/2015'),
(171,'06/28/2017'),
(172,'10/11/2013'),
(173,'11/20/2014'),
(174,'05/08/2016'),
(175,'03/03/2014'),
(176,'05/01/2016'),
(177,'09/21/2014'),
(178,'07/12/2013'),
(179,'02/23/2016'),
(180,'02/02/2014'),
(181,'03/21/2014'),
(182,'03/29/2018'),
(183,'09/14/2014'),
(184,'03/12/2018'),
(185,'12/28/2016'),
(186,'12/29/2016'),
(187,'05/09/2014'),
(188,'08/22/2013'),
(189,'07/25/2016'),
(190,'05/01/2016'),
(191,'02/04/2015'),
(192,'10/22/2016'),
(193,'05/18/2017'),
(194,'04/18/2015'),
(195,'12/02/2016'),
(196,'12/22/2013'),
(197,'02/10/2018'),
(198,'08/12/2015'),
(199,'08/16/2016'),
(200,'08/19/2013'),
(201,'06/02/2015'),
(202,'08/18/2016'),
(203,'09/01/2015'),
(204,'10/09/2014'),
(205,'07/12/2015'),
(206,'11/30/2014'),
(207,'10/10/2013'),
(208,'03/24/2014'),
(209,'11/30/2014'),
(210,'11/02/2014'),
(211,'02/13/2014'),
(212,'03/24/2017'),
(213,'08/16/2017'),
(214,'06/24/2013'),
(215,'09/17/2013'),
(216,'02/14/2015'),
(217,'11/12/2016'),
(218,'06/29/2016'),
(219,'05/19/2015'),
(220,'11/26/2015'),
(221,'07/06/2017'),
(222,'12/12/2016'),
(223,'09/17/2014'),
(224,'01/15/2017'),
(225,'08/22/2014'),
(226,'08/02/2015'),
(227,'07/22/2016'),
(228,'10/12/2016'),
(229,'04/28/2014'),
(230,'03/14/2014'),
(231,'02/07/2017'),
(232,'07/09/2013'),
(233,'09/27/2013'),
(234,'03/28/2017'),
(235,'05/05/2017'),
(236,'03/18/2017'),
(237,'05/02/2015'),
(238,'07/14/2014'),
(239,'10/19/2013'),
(240,'10/24/2014'),
(241,'11/14/2017'),
(242,'05/01/2018'),
(243,'01/30/2018'),
(244,'02/26/2016'),
(245,'12/12/2015'),
(246,'04/07/2017'),
(247,'12/15/2015'),
(248,'11/22/2015'),
(249,'03/05/2017'),
(250,'04/14/2018'),
(251,'07/28/2017'),
(252,'03/18/2015'),
(253,'03/19/2014'),
(254,'07/20/2016'),
(255,'10/06/2015'),
(256,'07/21/2013'),
(257,'02/23/2015'),
(258,'11/18/2015'),
(259,'09/27/2014'),
(260,'08/22/2013'),
(261,'12/31/2016'),
(262,'03/17/2015'),
(263,'04/22/2016'),
(264,'04/06/2015'),
(265,'11/12/2013'),
(266,'08/26/2016'),
(267,'07/14/2013'),
(268,'02/04/2014'),
(269,'06/24/2017'),
(270,'11/18/2017'),
(271,'02/21/2017'),
(272,'11/17/2014'),
(273,'05/19/2014'),
(274,'07/12/2017'),
(275,'07/31/2013'),
(276,'04/21/2017'),
(277,'09/09/2017'),
(278,'03/31/2014'),
(279,'02/08/2018'),
(280,'02/05/2014'),
(281,'12/15/2014'),
(282,'10/22/2016'),
(283,'06/28/2014'),
(284,'01/06/2015'),
(285,'09/08/2013'),
(286,'06/08/2016'),
(287,'10/06/2017'),
(288,'07/11/2013'),
(289,'06/18/2016'),
(290,'06/26/2016'),
(291,'04/01/2015'),
(292,'02/29/2016'),
(293,'01/01/2018'),
(294,'01/02/2018'),
(295,'04/28/2015'),
(296,'09/15/2015'),
(297,'10/26/2014'),
(298,'12/05/2016'),
(299,'07/15/2014'),
(300,'10/20/2017'),
(301,'06/11/2016'),
(302,'05/22/2017'),
(303,'12/02/2017'),
(304,'03/01/2018'),
(305,'08/17/2017'),
(306,'10/28/2015'),
(307,'08/23/2015'),
(308,'11/12/2014'),
(309,'01/01/2014'),
(310,'11/29/2013'),
(311,'12/31/2015'),
(312,'10/24/2016'),
(313,'10/02/2013'),
(314,'10/25/2017'),
(315,'12/06/2016'),
(316,'06/05/2017'),
(317,'09/03/2014'),
(318,'05/10/2018'),
(319,'03/01/2015'),
(320,'11/24/2013'),
(321,'04/02/2018'),
(322,'03/13/2015'),
(323,'04/20/2018'),
(324,'07/10/2014'),
(325,'10/13/2016'),
(326,'08/01/2016'),
(327,'05/30/2015'),
(328,'06/22/2014'),
(329,'12/25/2013'),
(330,'07/17/2017'),
(331,'04/08/2015'),
(332,'10/17/2016'),
(333,'07/24/2017'),
(334,'11/02/2015'),
(335,'07/11/2015'),
(336,'08/22/2016'),
(337,'04/27/2018'),
(338,'07/20/2013'),
(339,'07/30/2017'),
(340,'05/05/2016'),
(341,'07/27/2017'),
(342,'10/19/2015'),
(343,'09/03/2013'),
(344,'08/23/2013'),
(345,'06/14/2016'),
(346,'01/31/2015'),
(347,'09/17/2013'),
(348,'02/26/2014'),
(349,'10/26/2016'),
(350,'03/18/2014'),
(351,'09/26/2015'),
(352,'07/04/2015'),
(353,'03/15/2018'),
(354,'04/25/2014'),
(355,'02/07/2015'),
(356,'04/30/2017'),
(357,'07/06/2016'),
(358,'03/10/2018'),
(359,'03/19/2018'),
(360,'12/28/2013'),
(361,'09/15/2013'),
(362,'07/19/2013'),
(363,'08/26/2014'),
(364,'03/27/2015'),
(365,'12/04/2013'),
(366,'02/13/2016'),
(367,'07/07/2013'),
(368,'03/24/2017'),
(369,'05/30/2015'),
(370,'09/03/2017'),
(371,'12/22/2017'),
(372,'05/04/2018'),
(373,'07/17/2014'),
(374,'10/26/2015'),
(375,'01/27/2016'),
(376,'03/01/2017'),
(377,'08/06/2017'),
(378,'04/24/2016'),
(379,'07/20/2017'),
(380,'04/09/2014'),
(381,'11/22/2015'),
(382,'08/08/2017'),
(383,'12/27/2013'),
(384,'08/11/2016'),
(385,'09/13/2017'),
(386,'04/15/2015'),
(387,'04/03/2016'),
(388,'05/14/2015'),
(389,'03/18/2017'),
(390,'12/11/2013'),
(391,'03/07/2015'),
(392,'06/13/2017'),
(393,'09/26/2014'),
(394,'10/13/2016'),
(395,'01/05/2014'),
(396,'04/01/2017'),
(397,'04/12/2017'),
(398,'10/14/2017'),
(399,'09/05/2014'),
(400,'02/17/2017'),
(401,'11/13/2015'),
(402,'05/02/2017'),
(403,'10/04/2013'),
(404,'07/06/2016'),
(405,'02/14/2015'),
(406,'03/22/2016'),
(407,'01/28/2018'),
(408,'07/25/2015'),
(409,'02/10/2016'),
(410,'12/14/2016'),
(411,'01/28/2014'),
(412,'11/25/2017'),
(413,'12/18/2015'),
(414,'04/20/2016'),
(415,'09/27/2016'),
(416,'12/13/2015'),
(417,'02/28/2014'),
(418,'02/11/2015'),
(419,'05/16/2017'),
(420,'12/31/2015'),
(421,'09/28/2013'),
(422,'04/09/2014'),
(423,'11/07/2017'),
(424,'12/29/2013'),
(425,'04/22/2015'),
(426,'05/22/2016'),
(427,'03/18/2014'),
(428,'08/25/2015'),
(429,'12/18/2014'),
(430,'12/11/2014'),
(431,'03/28/2018'),
(432,'12/25/2014'),
(433,'09/19/2014'),
(434,'07/04/2015'),
(435,'08/04/2016'),
(436,'04/12/2015'),
(437,'12/25/2016'),
(438,'08/30/2017'),
(439,'01/17/2016'),
(440,'06/28/2013'),
(441,'04/19/2015'),
(442,'07/22/2016'),
(443,'07/06/2013'),
(444,'03/31/2015'),
(445,'07/21/2013'),
(446,'07/03/2014'),
(447,'04/23/2015'),
(448,'01/04/2016'),
(449,'08/19/2017'),
(450,'09/16/2013'),
(451,'04/23/2018'),
(452,'03/22/2014'),
(453,'02/17/2018'),
(454,'03/25/2015'),
(455,'10/21/2016'),
(456,'07/03/2016'),
(457,'03/09/2017'),
(458,'09/24/2016'),
(459,'11/16/2014'),
(460,'03/28/2015'),
(461,'02/23/2017'),
(462,'10/27/2016'),
(463,'08/31/2013'),
(464,'01/03/2014'),
(465,'07/07/2017'),
(466,'02/18/2014'),
(467,'08/29/2014'),
(468,'04/02/2017'),
(469,'07/09/2015'),
(470,'12/26/2016'),
(471,'09/28/2013'),
(472,'05/25/2015'),
(473,'01/29/2015'),
(474,'01/21/2015'),
(475,'05/04/2015'),
(476,'06/24/2017'),
(477,'01/06/2016'),
(478,'07/17/2016'),
(479,'02/21/2017'),
(480,'12/28/2013'),
(481,'04/04/2015'),
(482,'02/10/2015'),
(483,'01/18/2017'),
(484,'09/15/2015'),
(485,'04/23/2018'),
(486,'11/13/2013'),
(487,'07/08/2015'),
(488,'01/31/2015'),
(489,'11/05/2017'),
(490,'10/30/2016'),
(491,'06/22/2014'),
(492,'02/27/2015'),
(493,'03/10/2017'),
(494,'02/16/2017'),
(495,'08/06/2013'),
(496,'04/21/2017'),
(497,'02/28/2018'),
(498,'08/10/2014'),
(499,'02/02/2015'),
(500,'02/12/2014')
;

INSERT INTO petcare.customers
	(
		SELECT UserID
			, STR_TO_DATE(Dates, '%c/%e/%Y')
			FROM stage.cust_temp
	)
;


INSERT INTO petcare.pets (UserID, Name, PetTYpeID, Gender, Size, SpecialNeeds)
	(
		SELECT *
			FROM stage.pet_load_trans
	)
;

DELIMITER |

DROP TRIGGER IF EXISTS upd_customer|
CREATE TRIGGER upd_customer
	AFTER INSERT ON petcare.user
    FOR EACH ROW
    BEGIN
		INSERT INTO petcare.customers VALUES (new.UserID, CURRENT_DATE());
	END|
    
DELIMITER ;


INSERT INTO petcare.user 
	VALUES (501, 'Jones', 'Micajah', '123 Sesame Street', 'Springboro', 'OH', 'Springboro', '42837', 'mjone280@uncc.edu', '123-456-7890', 'Y', 2),
		   (502, 'Thesing', 'Jonathan', '111 Enigmatic Valley', 'Pepperidge Farms', 'MN', 'Winona', '55947', 'jthesing@uncc.edu', '234-567-8901', 'N', 17),
           (503, 'Gulley', 'Alexander', '1100 Waverly Lane', 'Walla Walla', 'WA', 'Walla Walla', '99362', 'agulley1@uncc.edu', '345-678-9012', 'N', 16),
           (504, 'Thompson', 'Pamela', '555 Cotswold Court', 'Lincoln', 'NE', 'Lincoln', '83475', 'plthomps@uncc.edu', '456-789-0123', 'N', 1),
           (505, 'Palagiri', 'Vinay', '999 Main Street', 'New York', 'NY', 'New York', '34945', 'vpalagir@uncc.edu', '567-890-1234', 'Y', 2)
;


INSERT INTO petcare.technicians
	VALUES (501, 1, 8, CAST('2018-06-19' AS DATE)),
		   (502, 1, 6, CAST('2018-06-19' AS DATE)),
           (503, 1, 4, CAST('2018-06-19' AS DATE)),
           (504, 0, 1, CAST('2018-06-19' AS DATE)),
           (505, 1, 3, CAST('2018-06-19' AS DATE))
;

INSERT INTO petcare.teacher
	(
		SELECT UserID, 'Instructor', concat(city, ' HS'), ROUND(RAND(),0)
			FROM petcare.user 
			WHERE OccupationID = 1
	)
;

CALL create_order(1, CURRENT_DATE(), 501, 8, 6);
CALL create_order(2, CURRENT_DATE(), 502, 14, 5);
CALL create_order(3, CURRENT_DATE(), 503, 21, 1);
CALL create_order(4, CURRENT_DATE(), 504, 9, 5);
CALL create_order(5, CURRENT_DATE(), 505, 18, 6);
